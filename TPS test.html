<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Osu! TPS Test</title>
    <style>
        :root {
            --osu-pink: #ff66aa;
            --osu-dark-pink: #e64d95;
            --osu-purple: #a366ff;
            --osu-dark: #2d2d42;
            --osu-darker: #1a1a2e;
            --osu-light: #f2f2f2;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--osu-darker) 0%, var(--osu-dark) 100%);
            color: var(--osu-light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            color: var(--osu-pink);
            text-shadow: 0 0 10px rgba(255, 102, 170, 0.5);
        }

        .subtitle {
            font-size: 1.2rem;
            color: var(--osu-light);
            opacity: 0.8;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        .control-panel {
            display: flex;
            flex-direction: column;
        }

        .counter {
            text-align: center;
            margin-bottom: 20px;
        }

        #counter {
            font-size: 3.5rem;
            font-weight: bold;
            color: var(--osu-pink);
            text-shadow: 0 0 15px rgba(255, 102, 170, 0.7);
            margin-bottom: 5px;
            transition: all 0.2s ease;
        }

        #cps-counter {
            font-size: 1.5rem;
            opacity: 0.9;
            transition: all 0.3s ease;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-primary {
            background: var(--osu-pink);
            color: white;
        }

        .btn-primary:hover {
            background: var(--osu-dark-pink);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--osu-purple);
            color: white;
        }

        .btn-secondary:hover {
            background: #8a4fff;
            transform: translateY(-2px);
        }

        .settings {
            margin: 20px 0;
        }

        .setting-group {
            margin-bottom: 15px;
        }

        .setting-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--osu-pink);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--osu-pink);
        }

        input:checked + .slider:before {
            transform: translateX(30px);
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .number-input {
            width: 80px;
            padding: 10px;
            border-radius: 8px;
            border: 2px solid var(--osu-purple);
            background: rgba(0, 0, 0, 0.2);
            color: white;
            font-size: 1rem;
        }

        .key-binds {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .key-btn {
            padding: 10px 15px;
            background: rgba(255, 102, 170, 0.2);
            border: 2px solid var(--osu-pink);
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 60px;
            text-align: center;
        }

        .key-btn:hover {
            background: rgba(255, 102, 170, 0.3);
        }

        .key-btn.active {
            background: var(--osu-pink);
            box-shadow: 0 0 15px rgba(255, 102, 170, 0.5);
        }

        .key-btn.rebinding {
            animation: rebind-pulse 1s infinite;
        }

        @keyframes rebind-pulse {
            0% { background-color: rgba(255, 102, 170, 0.2); }
            50% { background-color: rgba(255, 102, 170, 0.8); }
            100% { background-color: rgba(255, 102, 170, 0.2); }
        }

        .stats-panel {
            display: flex;
            flex-direction: column;
        }

        .stat-section {
            margin-bottom: 25px;
        }

        .stat-title {
            color: var(--osu-pink);
            font-size: 1.5rem;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--osu-purple);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-label {
            font-weight: bold;
        }

        .stat-value {
            color: var(--osu-pink);
            font-weight: bold;
        }

        .history-panel {
            margin-top: 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .history-table th,
        .history-table td {
            padding: 12px 15px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .history-table th {
            background: rgba(255, 102, 170, 0.2);
            color: var(--osu-pink);
            font-weight: bold;
        }

        .history-table tr:hover {
            background: rgba(255, 102, 170, 0.1);
        }

        footer {
            text-align: center;
            margin-top: auto;
            padding: 20px;
            opacity: 0.7;
            font-size: 0.9rem;
        }

        .pulse {
            animation: pulse 0.5s;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            background: var(--osu-dark);
            border-left: 4px solid var(--osu-pink);
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .reference-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .reference-table th, 
        .reference-table td {
            padding: 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .reference-table th {
            background: rgba(255, 102, 170, 0.2);
            color: var(--osu-pink);
        }
        
        .reference-table tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .reference-table tr:hover {
            background: rgba(255, 102, 170, 0.1);
        }
        
        .current-level {
            background: rgba(255, 102, 170, 0.3) !important;
            font-weight: bold;
        }
        
        .rank-badge {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 5px;
            text-align: center;
            line-height: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .rank-1 { background: linear-gradient(135deg, #ffcc00, #ff9900); color: #000; }
        .rank-2 { background: linear-gradient(135deg, #c0c0c0, #a0a0a0); color: #000; }
        .rank-3 { background: linear-gradient(135deg, #cd7f32, #a56c28); color: #000; }
        .rank-4 { background: linear-gradient(135deg, #ff66aa, #e64d95); color: #fff; }
        .rank-5 { background: linear-gradient(135deg, #a366ff, #8a4fff); color: #fff; }
        .rank-6 { background: linear-gradient(135deg, #66b2ff, #4d95e6); color: #fff; }
        
        .footer-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .footer-link {
            display: flex;
            align-items: center;
            color: var(--osu-pink);
            text-decoration: none;
            transition: all 0.2s ease;
        }
        
        .footer-link:hover {
            color: var(--osu-light);
            transform: translateY(-2px);
        }
        
        .footer-link-icon {
            margin-right: 8px;
            width: 18px;
            height: 18px;
        }
        
        .footer-separator {
            margin: 0 10px;
            color: var(--osu-purple);
        }
        
        .footer-credits {
            margin-top: 10px;
            font-size: 0.85rem;
            opacity: 0.8;
        }

        /* Новые анимации для индикатора CPS */
        @keyframes idle-sway {
            0% { transform: translateX(0) scale(1); }
            25% { transform: translateX(-2px) scale(1.01); }
            50% { transform: translateX(2px) scale(1); }
            75% { transform: translateX(-1px) scale(1.01); }
            100% { transform: translateX(0) scale(1); }
        }

        @keyframes click-shake {
            0% { transform: translateX(0) scale(1); }
            25% { transform: translateX(-3px) scale(1.05); }
            50% { transform: translateX(3px) scale(1.1); }
            75% { transform: translateX(-2px) scale(1.05); }
            100% { transform: translateX(0) scale(1); }
        }

        .idle-animation {
            animation: idle-sway 3s infinite ease-in-out;
        }

        .click-animation {
            animation: click-shake 0.2s ease-out;
        }

        .cps-indicator {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Osu! TPS Test</h1>
            <p class="subtitle">Test your taps per second like a true Osu! player</p>
        </header>

        <div class="main-content">
            <div class="panel control-panel">
                <div class="counter">
                    <div id="counter" class="idle-animation">idle</div>
                    <div id="cps-counter" class="cps-indicator">0 cps</div>
                </div>

                <div class="controls">
                    <button id="start-button" class="btn btn-primary">Start</button>
                    <button id="clear-button" class="btn btn-secondary">Clear</button>
                </div>

                <div class="settings">
                    <div class="setting-group">
                        <span class="setting-label">Mode</span>
                        <label class="switch">
                            <input id="mode-switch" type="checkbox" checked>
                            <span class="slider"></span>
                        </label>
                        <span id="mode-label">Timer Mode</span>
                    </div>

                    <div class="setting-group" id="timer-set">
                        <span class="setting-label">Time (seconds)</span>
                        <div class="input-group">
                            <input id="time-control" type="number" min="1" max="3600" class="number-input" value="5">
                        </div>
                    </div>

                    <div class="setting-group" id="clicks-set" style="display: none;">
                        <span class="setting-label">Clicks</span>
                        <div class="input-group">
                            <input id="clicks-control" type="number" min="1" max="9999" class="number-input" value="20">
                        </div>
                    </div>

                    <div class="setting-group">
                        <span class="setting-label">Key Bindings</span>
                        <div class="key-binds">
                            <div id="key1" class="key-btn" title="Click to rebind">Z</div>
                            <div id="key2" class="key-btn" title="Click to rebind">X</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel stats-panel">
                <div class="stat-section">
                    <h3 class="stat-title">RESULT</h3>
                    <div class="stat-item">
                        <span class="stat-label">Score</span>
                        <span id="score" class="stat-value">0 clicks</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Time</span>
                        <span id="time" class="stat-value">0 sec</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Frequency</span>
                        <span id="freq" class="stat-value">0 cps</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Osu! Level</span>
                        <span id="level" class="stat-value">-</span>
                    </div>
                </div>

                <div class="stat-section">
                    <h3 class="stat-title">TOTAL</h3>
                    <div class="stat-item">
                        <span class="stat-label">Max CPS</span>
                        <span id="max" class="stat-value">0 cps</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Min CPS</span>
                        <span id="min" class="stat-value">0 cps</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Avg CPS</span>
                        <span id="avg" class="stat-value">0 cps</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel">
            <h3 class="stat-title">Osu! Player Skill Reference</h3>
            <table class="reference-table">
                <thead>
                    <tr>
                        <th>CPS Range</th>
                        <th>Player Rank</th>
                        <th>Star Rating</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody id="reference-body">
                    <tr>
                        <td>0 - 5</td>
                        <td><span class="rank-badge rank-6">F</span> Beginner</td>
                        <td>⭐ 1.0 - 2.0</td>
                        <td>Just starting out, learning basics</td>
                    </tr>
                    <tr>
                        <td>5 - 7</td>
                        <td><span class="rank-badge rank-5">E</span> Novice</td>
                        <td>⭐ 2.0 - 3.5</td>
                        <td>Can complete easier maps, improving fundamentals</td>
                    </tr>
                    <tr>
                        <td>7 - 9</td>
                        <td><span class="rank-badge rank-4">D</span> Average</td>
                        <td>⭐ 3.5 - 4.5</td>
                        <td>Comfortable with moderate tempo maps</td>
                    </tr>
                    <tr>
                        <td>9 - 11</td>
                        <td><span class="rank-badge rank-3">C</span> Intermediate</td>
                        <td>⭐ 4.5 - 5.5</td>
                        <td>Can handle faster patterns with consistency</td>
                    </tr>
                    <tr>
                        <td>11 - 13</td>
                        <td><span class="rank-badge rank-2">B</span> Skilled</td>
                        <td>⭐ 5.5 - 6.5</td>
                        <td>Good speed and accuracy, can play challenging maps</td>
                    </tr>
                    <tr>
                        <td>13 - 15</td>
                        <td><span class="rank-badge rank-1">A</span> Advanced</td>
                        <td>⭐ 6.5 - 7.5</td>
                        <td>High speed, good accuracy, expert-level maps</td>
                    </tr>
                    <tr>
                        <td>15 - 17</td>
                        <td><span class="rank-badge" style="background:linear-gradient(135deg, #ff66aa, #a366ff); color:#fff">S</span> Expert</td>
                        <td>⭐ 7.5 - 8.5</td>
                        <td>Exceptional speed and precision, top-tier player</td>
                    </tr>
                    <tr>
                        <td>17+</td>
                        <td><span class="rank-badge" style="background:linear-gradient(135deg, #ffcc00, #ff66aa); color:#000">SS</span> Elite</td>
                        <td>⭐ 8.5+</td>
                        <td>Extreme speed, tournament-level performance</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="history-panel">
            <h3 class="stat-title">Last 10 Results</h3>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Score</th>
                        <th>Time</th>
                        <th>CPS</th>
                        <th>Rank</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody id="history-body">
                    <!-- Results will be added here dynamically -->
                </tbody>
            </table>
        </div>

        <footer>
            <div class="footer-links">
                <a href="https://osu.ppy.sh/community/forums/topics/1051329?n=1" class="footer-link" target="_blank">
                    <svg class="footer-link-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M14,3V5H17.59L7.76,14.83L9.17,16.24L19,6.41V10H21V3M19,19H5V5H12V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V12H19V19Z" />
                    </svg>
                    Original Post
                </a>
                
                <span class="footer-separator">|</span>
                
                <a href="https://osu.ppy.sh/users/9332747" class="footer-link" target="_blank">
                    <svg class="footer-link-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" />
                    </svg>
                    My Osu! Profile
                </a>
                
                <span class="footer-separator">|</span>
                
                <a href="#" class="footer-link">
                    <svg class="footer-link-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M14,3V5H17.59L7.76,14.83L9.17,16.24L19,6.41V10H21V3M19,19H5V5H12V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V12H19V19Z" />
                    </svg>
                    My Post (Coming Soon)
                </a>
            </div>
            
            <div class="footer-credits">
                <p>Based on original work by <a href="https://vk.com/metriss" class="footer-link" target="_blank" style="display: inline; color: var(--osu-pink);">metriss</a></p>
            </div>
            
            <p>Made for Osu! players | TPS Test v2.6</p>
        </footer>
    </div>

    <div class="notification" id="notification">
        Key binding updated successfully!
    </div>

    <script>
        // Game state variables
        let mode = 0;
        let timerMode = true;
        let clicks = 0;
        let sclicks = 0;
        let timerTime = 5;
        let streamClicks = 20;
        let clicksLeft = streamClicks;
        let passed = 0;
        let streamStart = 0;
        let freqs = [];
        let bindNum = 0;
        let countdown, finish;
        let history = [];
        let lastClickTime = 0;
        let currentCps = 0;

        // DOM elements
        const counter = document.getElementById("counter");
        const cpsCounter = document.getElementById("cps-counter");
        const startButton = document.getElementById("start-button");
        const clearButton = document.getElementById("clear-button");
        const scoreMetric = document.getElementById("score");
        const timeMetric = document.getElementById("time");
        const freqMetric = document.getElementById("freq");
        const levelMetric = document.getElementById("level");
        const maxMetric = document.getElementById("max");
        const minMetric = document.getElementById("min");
        const avgMetric = document.getElementById("avg");
        const timerSet = document.getElementById("timer-set");
        const clicksSet = document.getElementById("clicks-set");
        const modeSwitch = document.getElementById("mode-switch");
        const modeLabel = document.getElementById("mode-label");
        const key1 = document.getElementById("key1");
        const key2 = document.getElementById("key2");
        const historyBody = document.getElementById("history-body");
        const timeControl = document.getElementById("time-control");
        const clicksControl = document.getElementById("clicks-control");
        const notification = document.getElementById("notification");
        const referenceBody = document.getElementById("reference-body");

        // Key bindings
        let binds = {
            1: 'KeyZ',
            2: 'KeyX'
        };

        // Player skill levels based on realistic Osu! rankings
        const skillLevels = [
            { min: 0, max: 5, rank: "F", name: "Beginner", stars: "⭐ 1.0 - 2.0", desc: "Just starting out, learning basics" },
            { min: 5, max: 7, rank: "E", name: "Novice", stars: "⭐ 2.0 - 3.5", desc: "Can complete easier maps, improving fundamentals" },
            { min: 7, max: 9, rank: "D", name: "Average", stars: "⭐ 3.5 - 4.5", desc: "Comfortable with moderate tempo maps" },
            { min: 9, max: 11, rank: "C", name: "Intermediate", stars: "⭐ 4.5 - 5.5", desc: "Can handle faster patterns with consistency" },
            { min: 11, max: 13, rank: "B", name: "Skilled", stars: "⭐ 5.5 - 6.5", desc: "Good speed and accuracy, can play challenging maps" },
            { min: 13, max: 15, rank: "A", name: "Advanced", stars: "⭐ 6.5 - 7.5", desc: "High speed, good accuracy, expert-level maps" },
            { min: 15, max: 17, rank: "S", name: "Expert", stars: "⭐ 7.5 - 8.5", desc: "Exceptional speed and precision, top-tier player" },
            { min: 17, max: 999, rank: "SS", name: "Elite", stars: "⭐ 8.5+", desc: "Extreme speed, tournament-level performance" }
        ];

        // Get skill level based on CPS
        function getSkillLevel(cps) {
            for (const level of skillLevels) {
                if (cps >= level.min && cps < level.max) {
                    return level;
                }
            }
            return skillLevels[skillLevels.length - 1];
        }

        // Update reference table highlighting
        function updateReferenceTable(cps) {
            const rows = referenceBody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                const level = skillLevels[index];
                if (cps >= level.min && cps < level.max) {
                    row.classList.add('current-level');
                } else {
                    row.classList.remove('current-level');
                }
            });
        }

        // Get color based on CPS value
        function getColorForCps(cps) {
            if (cps < 5) return '#4CAF50'; // Green
            if (cps < 10) return '#FFC107'; // Yellow
            if (cps < 15) return '#FF9800'; // Orange
            if (cps < 20) return '#F44336'; // Red
            return '#9C27B0'; // Purple for extreme speeds
        }

        // Update CPS indicator appearance
        function updateCpsIndicator(cps) {
            const color = getColorForCps(cps);
            cpsCounter.style.color = color;
            cpsCounter.style.textShadow = `0 0 10px ${color}40`;
            
            // Scale based on CPS (up to 1.5x for very high CPS)
            const scale = 1 + Math.min(cps * 0.03, 0.5);
            cpsCounter.style.transform = `scale(${scale})`;
        }

        // Show notification
        function showNotification(message) {
            notification.textContent = message;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 2000);
        }

        // Load history from localStorage
        function loadHistory() {
            const savedHistory = localStorage.getItem('tpsHistory');
            if (savedHistory) {
                history = JSON.parse(savedHistory);
                updateHistoryTable();
            }
        }

        // Save history to localStorage
        function saveHistory() {
            localStorage.setItem('tpsHistory', JSON.stringify(history));
        }

        // Update history table (new results on top)
        function updateHistoryTable() {
            historyBody.innerHTML = '';
            
            // Show only last 10 results, with newest first
            const displayHistory = history.slice(-10).reverse();
            
            displayHistory.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${displayHistory.length - index}</td>
                    <td>${item.score} clicks</td>
                    <td>${item.time} sec</td>
                    <td>${item.cps} cps</td>
                    <td>${item.rank}</td>
                    <td>${new Date(item.date).toLocaleTimeString()}</td>
                `;
                historyBody.appendChild(row);
            });
        }

        // Add result to history
        function addToHistory(score, time, cps, rank) {
            history.push({
                score,
                time,
                cps,
                rank,
                date: new Date().toISOString()
            });
            
            // Keep only last 10 results
            if (history.length > 10) {
                history = history.slice(-10);
            }
            
            saveHistory();
            updateHistoryTable();
        }

        // Calculate max, min, average
        function maxMinAvg(arr) {
            if (arr.length === 0) return [0, 0, 0];
            
            let max = arr[0];
            let min = arr[0];
            let sum = arr[0];
            
            for (let i = 1; i < arr.length; i++) {
                if (arr[i] > max) max = arr[i];
                if (arr[i] < min) min = arr[i];
                sum += arr[i];
            }
            
            return [max, min, sum / arr.length];
        }

        // Switch between timer and clicks mode
        function switchMode() {
            timerMode = modeSwitch.checked;
            
            if (timerMode) {
                timerSet.style.display = 'block';
                clicksSet.style.display = 'none';
                modeLabel.textContent = 'Timer Mode';
            } else {
                timerSet.style.display = 'none';
                clicksSet.style.display = 'block';
                modeLabel.textContent = 'Clicks Mode';
            }
        }

        // Clear results
        function clearResults(clearGlobal) {
            scoreMetric.textContent = '0 clicks';
            timeMetric.textContent = '0 sec';
            freqMetric.textContent = '0 cps';
            levelMetric.textContent = '-';
            
            // Reset CPS indicator
            cpsCounter.textContent = '0 cps';
            cpsCounter.style.color = '';
            cpsCounter.style.textShadow = '';
            cpsCounter.style.transform = '';
            
            // Reset reference table highlighting
            const rows = referenceBody.querySelectorAll('tr');
            rows.forEach(row => row.classList.remove('current-level'));
            
            if (clearGlobal) {
                freqs = [];
                maxMetric.textContent = '0 cps';
                minMetric.textContent = '0 cps';
                avgMetric.textContent = '0 cps';
                history = [];
                saveHistory();
                updateHistoryTable();
            }
        }

        // Update time setting
        function updateTime() {
            const value = parseInt(timeControl.value);
            if (value > 0 && value <= 3600) {
                timerTime = value;
            } else if (value <= 0) {
                timerTime = 1;
                timeControl.value = 1;
            } else if (value > 3600) {
                timerTime = 3600;
                timeControl.value = 3600;
            }
        }

        // Update clicks setting
        function updateClicks() {
            const value = parseInt(clicksControl.value);
            if (value > 0 && value <= 9999) {
                streamClicks = value;
            } else if (value <= 0) {
                streamClicks = 1;
                clicksControl.value = 1;
            } else if (value > 9999) {
                streamClicks = 9999;
                clicksControl.value = 9999;
            }
        }

        // Key binding change
        function changeBinding(e) {
            e.preventDefault();
            if (bindNum && e.code) {
                binds[bindNum] = e.code;
                
                const keyName = e.code.startsWith('Key') ? e.code.substring(3) : e.code;
                
                if (bindNum === 1) {
                    key1.textContent = keyName;
                    key1.classList.remove('rebinding');
                    showNotification("Primary key bound to: " + keyName);
                } else {
                    key2.textContent = keyName;
                    key2.classList.remove('rebinding');
                    showNotification("Secondary key bound to: " + keyName);
                }
                
                document.removeEventListener('keydown', changeBinding);
                bindNum = 0;
            }
        }

        // Initiate key rebinding
        function rebind(keyNum) {
            if (!mode && !bindNum) {
                bindNum = keyNum;
                
                if (keyNum === 1) {
                    key1.textContent = 'Press any key';
                    key1.classList.add('rebinding');
                } else {
                    key2.textContent = 'Press any key';
                    key2.classList.add('rebinding');
                }
                
                document.addEventListener('keydown', changeBinding);
            }
        }

        // Handle key press
        function handleKeyPress(e) {
            if (timerMode) {
                if (e.code === binds[1] || e.code === binds[2]) {
                    clicks++;
                    sclicks++;
                    scoreMetric.textContent = `${clicks} clicks`;
                    
                    // Calculate current CPS for visual feedback
                    const now = Date.now();
                    const elapsed = (now - streamStart) / 1000;
                    currentCps = elapsed > 0 ? (clicks / elapsed) : clicks;
                    
                    // Update CPS indicator
                    cpsCounter.textContent = `${currentCps.toFixed(1)} cps`;
                    updateCpsIndicator(currentCps);
                    
                    // Add visual feedback to counter
                    counter.classList.add('click-animation');
                    setTimeout(() => counter.classList.remove('click-animation'), 200);
                    
                    // Add visual feedback to keys
                    if (e.code === binds[1]) {
                        key1.classList.add('active');
                    } else {
                        key2.classList.add('active');
                    }
                }
            } else {
                if (e.code === binds[1] || e.code === binds[2]) {
                    clicks++;
                    clicksLeft--;
                    scoreMetric.textContent = `${clicks} clicks`;
                    counter.textContent = `${clicksLeft} left`;
                    
                    const cps = (clicks / ((Date.now() - streamStart) / 1000)).toFixed(1);
                    currentCps = parseFloat(cps);
                    cpsCounter.textContent = `${cps} cps`;
                    
                    // Update CPS indicator
                    updateCpsIndicator(currentCps);
                    
                    // Add visual feedback
                    counter.classList.add('click-animation');
                    setTimeout(() => counter.classList.remove('click-animation'), 200);
                    
                    if (e.code === binds[1]) {
                        key1.classList.add('active');
                    } else {
                        key2.classList.add('active');
                    }
                    
                    if (clicksLeft <= 0) {
                        stopTracking();
                    }
                }
            }
        }

        // Handle key release
        function handleKeyRelease(e) {
            if (e.code === binds[1]) {
                key1.classList.remove('active');
            } else if (e.code === binds[2]) {
                key2.classList.remove('active');
            }
        }

        // Stop tracking
        function stopTracking() {
            if (mode) {
                const streamEnd = Date.now();
                
                if (timerMode) {
                    clearInterval(countdown);
                    clearTimeout(finish);
                }
                
                document.removeEventListener('keydown', handleKeyPress);
                document.removeEventListener('keyup', handleKeyRelease);
                
                // Calculate results
                let resultTime, resultCps, resultLevel;
                
                if (timerMode) {
                    resultTime = passed;
                    resultCps = resultTime > 0 ? (clicks / resultTime).toFixed(1) : clicks;
                    resultLevel = getSkillLevel(resultCps);
                } else {
                    resultTime = ((streamEnd - streamStart) / 1000).toFixed(1);
                    resultCps = resultTime > 0 ? (clicks / resultTime).toFixed(1) : 0;
                    resultLevel = getSkillLevel(resultCps);
                }
                
                // Update metrics
                timeMetric.textContent = `${resultTime} sec`;
                freqMetric.textContent = `${resultCps} cps`;
                levelMetric.textContent = `${resultLevel.rank} - ${resultLevel.name}`;
                
                // Update reference table
                updateReferenceTable(parseFloat(resultCps));
                
                // Add to history
                addToHistory(clicks, resultTime, resultCps, resultLevel.rank);
                
                // Update global stats if we have valid results
                if (clicks > 0) {
                    freqs.push(parseFloat(resultCps));
                    
                    const [maxCps, minCps, avgCps] = maxMinAvg(freqs);
                    
                    maxMetric.textContent = `${maxCps.toFixed(1)} cps`;
                    minMetric.textContent = `${minCps.toFixed(1)} cps`;
                    avgMetric.textContent = `${avgCps.toFixed(1)} cps`;
                }
                
                // Reset state
                clicks = 0;
                passed = 0;
                currentCps = 0;
                counter.textContent = 'idle';
                counter.classList.add('idle-animation');
                cpsCounter.textContent = '0 cps';
                cpsCounter.style.color = '';
                cpsCounter.style.textShadow = '';
                cpsCounter.style.transform = '';
                startButton.textContent = 'Start';
                startButton.classList.remove('btn-secondary');
                startButton.classList.add('btn-primary');
                mode = 0;
            }
        }

        // Start tracking
        function startTracking() {
            if (!mode && !bindNum) {
                // Update settings from inputs
                updateTime();
                updateClicks();
                
                clearResults(false);
                mode = 1;
                counter.classList.remove('idle-animation');
                
                if (timerMode) {
                    document.addEventListener('keydown', handleKeyPress);
                    document.addEventListener('keyup', handleKeyRelease);
                    
                    counter.textContent = `${timerTime} sec`;
                    startButton.textContent = 'Stop';
                    startButton.classList.remove('btn-primary');
                    startButton.classList.add('btn-secondary');
                    
                    let timeLeft = timerTime;
                    passed = 0;
                    streamStart = Date.now();
                    
                    countdown = setInterval(() => {
                        timeLeft--;
                        passed = timerTime - timeLeft;
                        
                        timeMetric.textContent = `${passed} sec`;
                        cpsCounter.textContent = `${sclicks} cps`;
                        updateCpsIndicator(sclicks);
                        sclicks = 0;
                        
                        counter.textContent = `${timeLeft} sec`;
                        
                        if (timeLeft <= 0) {
                            clearInterval(countdown);
                        }
                    }, 1000);
                    
                    finish = setTimeout(stopTracking, timerTime * 1000);
                } else {
                    document.addEventListener('keydown', handleKeyPress);
                    document.addEventListener('keyup', handleKeyRelease);
                    
                    streamStart = Date.now();
                    clicksLeft = streamClicks;
                    
                    counter.textContent = `${clicksLeft} left`;
                    startButton.textContent = 'Stop';
                    startButton.classList.remove('btn-primary');
                    startButton.classList.add('btn-secondary');
                }
            } else {
                stopTracking();
            }
        }

        // Initialize the application
        function init() {
            // Load history
            loadHistory();
            
            // Set up event listeners
            startButton.addEventListener('click', startTracking);
            clearButton.addEventListener('click', () => clearResults(true));
            
            modeSwitch.addEventListener('change', switchMode);
            switchMode(); // Initialize mode
            
            timeControl.addEventListener('change', updateTime);
            timeControl.addEventListener('input', updateTime);
            
            clicksControl.addEventListener('change', updateClicks);
            clicksControl.addEventListener('input', updateClicks);
            
            key1.addEventListener('click', () => rebind(1));
            key2.addEventListener('click', () => rebind(2));
            
            // Initialize values
            updateTime();
            updateClicks();
        }

        // Start the application when the page loads
        window.addEventListener('load', init);
    </script>
</body>
</html>